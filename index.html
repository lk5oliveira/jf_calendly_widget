<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendly Widget</title>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>
<body>
    <input type="text" id='userInput' hidden>
    <div class="calendly-inline-widget" data-url="" style="min-width:320px;height:630px;" data-processed="true"></div>
<script>

    let event;
    let calendlyViewed = false;
    let iframeContainer = document.querySelector('.calendly-inline-widget');
    let name, email;

    function initializeCalendlyWidget() {
        let newUrl = JFCustomWidget.getWidgetSetting('calendlyUrl');
        if (iframeContainer) {
            iframeContainer.setAttribute('data-url', newUrl + `?hide_event_type_details=1&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`);
        }

        let script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'https://assets.calendly.com/assets/external/widget.js';
        script.async = true;

        document.body.appendChild(script);

        window.addEventListener('message', handleCalendlyEvent);
    }

    function handleCalendlyEvent(e) {
        if (isCalendlyEvent(e)) {
            event = e.data;
            console.log(event.event);

            if (event.event == 'calendly.event_type_viewed') {
                calendlyViewed = true;
            }

            if (event.event == 'calendly.page_height' && calendlyViewed == true) {
                let newHeight = event.payload.height;
                console.log(newHeight);
                iframeContainer.style.height = newHeight + 'px';
                JFCustomWidget.requestFrameResize({ height: newHeight });
            }

            if (event.event == 'calendly.event_scheduled') {
                document.getElementById('userInput').value = 'booked';
                iframeContainer.style.height = '490px';
                JFCustomWidget.requestFrameResize({ height: 420 });
            }
        }
    }

    function isCalendlyEvent(e) {
        return e.data.event && e.data.event.indexOf('calendly') === 0;
    }

    JFCustomWidget.subscribe("ready", function() {
        name = JFCustomWidget.getWidgetSetting('name');
        email = JFCustomWidget.getWidgetSetting('email');

        initializeCalendlyWidget();

        JFCustomWidget.listenFromField(name, "change", function(value) {
            console.log(value);
            name = value;
            reloadCalendlyScript();
        });

        JFCustomWidget.listenFromField(email, "change", function(value) {
            console.log(value);
            email = value;
            reloadCalendlyScript();
        });

        JFCustomWidget.subscribe("submit", function() {
            let msg = {valid: false};
            if (event.event == 'calendly.event_scheduled') {
                msg = {
                    valid: true,
                    value: document.getElementById('userInput').value
                };
            }

            // send value to JotForm
            JFCustomWidget.sendSubmit(msg);
        });
    });

    function reloadCalendlyScript() {
        // Remove the existing script
        let oldScript = document.querySelector('script[src="https://assets.calendly.com/assets/external/widget.js"]');
        if (oldScript) {
            oldScript.remove();
        }

        // Clear the Calendly widget container
        iframeContainer.innerHTML = '';

        // Re-initialize the Calendly widget
        initializeCalendlyWidget();
    }

</script>
</body>
</html>
